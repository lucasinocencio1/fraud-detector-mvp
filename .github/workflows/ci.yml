name: CI

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  PYTHONPATH: ${{ github.workspace }}
  DISABLE_PANDERA_IMPORT_WARNING: "1"

jobs:
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify project loads
        run: python -c "import src.server.app; import src.data.cli; import src.utils.features"
  
  test:
    name: Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ensure sample data exists
        run: |
          mkdir -p data
          if [ ! -f data/sample_transactions.csv ]; then
            python -c "
          import pandas as pd
          from pathlib import Path
          Path('data').mkdir(exist_ok=True)
          df = pd.DataFrame([
              {'transaction_id':'t1','time':0,'amount':120.5,'region':'US','device_type':'mobile','merchant_category':'electronics','transaction_hour':10,'is_weekend':0,'avg_amount_user':80,'amount_to_avg_ratio':1.5,'tx_last_24h':2,'tx_last_7d':5,'class':1},
              {'transaction_id':'t2','time':1,'amount':45,'region':'EU','device_type':'desktop','merchant_category':'groceries','transaction_hour':14,'is_weekend':0,'avg_amount_user':55,'amount_to_avg_ratio':0.82,'tx_last_24h':1,'tx_last_7d':4,'class':0},
              {'transaction_id':'t3','time':2,'amount':310,'region':'US','device_type':'mobile','merchant_category':'travel','transaction_hour':1,'is_weekend':0,'avg_amount_user':95,'amount_to_avg_ratio':3.27,'tx_last_24h':5,'tx_last_7d':9,'class':1},
              {'transaction_id':'t4','time':3,'amount':25,'region':'BR','device_type':'mobile','merchant_category':'restaurants','transaction_hour':20,'is_weekend':1,'avg_amount_user':30,'amount_to_avg_ratio':0.84,'tx_last_24h':0,'tx_last_7d':2,'class':0},
              {'transaction_id':'t5','time':4,'amount':78,'region':'EU','device_type':'desktop','merchant_category':'electronics','transaction_hour':8,'is_weekend':0,'avg_amount_user':60,'amount_to_avg_ratio':1.3,'tx_last_24h':3,'tx_last_7d':7,'class':0},
          ])
          df.to_csv('data/sample_transactions.csv', index=False)
          "
          fi
      - name: Prepare data artifacts
        run: python -m src.data.cli full-run --batch-path data/sample_transactions.csv

      - name: Run tests
        run: |
          pytest tests/ -v --cov=src --cov-report=xml --cov-report=term-missing --cov-fail-under=70

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
  
  train:
    name: Model Training & Validation
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ensure sample data exists
        run: |
          mkdir -p data
          if [ ! -f data/sample_transactions.csv ]; then
            python -c "
          import pandas as pd
          from pathlib import Path
          Path('data').mkdir(exist_ok=True)
          df = pd.DataFrame([
              {'transaction_id':'t1','time':0,'amount':120.5,'region':'US','device_type':'mobile','merchant_category':'electronics','transaction_hour':10,'is_weekend':0,'avg_amount_user':80,'amount_to_avg_ratio':1.5,'tx_last_24h':2,'tx_last_7d':5,'class':1},
              {'transaction_id':'t2','time':1,'amount':45,'region':'EU','device_type':'desktop','merchant_category':'groceries','transaction_hour':14,'is_weekend':0,'avg_amount_user':55,'amount_to_avg_ratio':0.82,'tx_last_24h':1,'tx_last_7d':4,'class':0},
              {'transaction_id':'t3','time':2,'amount':310,'region':'US','device_type':'mobile','merchant_category':'travel','transaction_hour':1,'is_weekend':0,'avg_amount_user':95,'amount_to_avg_ratio':3.27,'tx_last_24h':5,'tx_last_7d':9,'class':1},
              {'transaction_id':'t4','time':3,'amount':25,'region':'BR','device_type':'mobile','merchant_category':'restaurants','transaction_hour':20,'is_weekend':1,'avg_amount_user':30,'amount_to_avg_ratio':0.84,'tx_last_24h':0,'tx_last_7d':2,'class':0},
              {'transaction_id':'t5','time':4,'amount':78,'region':'EU','device_type':'desktop','merchant_category':'electronics','transaction_hour':8,'is_weekend':0,'avg_amount_user':60,'amount_to_avg_ratio':1.3,'tx_last_24h':3,'tx_last_7d':7,'class':0},
          ])
          df.to_csv('data/sample_transactions.csv', index=False)
          "
          fi
      - name: Prepare data artifacts
        run: python -m src.data.cli full-run --batch-path data/sample_transactions.csv

      - name: Train supervised model
        run: python src/models/train_supervised.py

      - name: Evaluate models
        run: python src/models/evaluate.py

      - name: Validate model performance
        run: |
          python - <<'PY'
          import json, sys
          from pathlib import Path

          metrics_path = Path("artifacts/metrics.json")
          if not metrics_path.exists():
              print("Metrics file not found, aborting validation.", file=sys.stderr)
              sys.exit(1)

          with metrics_path.open() as handle:
              metrics = json.load(handle)

          auprc = metrics.get("AUPRC", 0)
          precision = metrics.get("Precision_at_1pct", 0)

          if auprc < 0:
              raise SystemExit(f"AUPRC invalid: {auprc}")
          if precision < 0:
              raise SystemExit(f"Precision@1% invalid: {precision}")

          print("Metrics within acceptable thresholds.")
          PY

      - name: Upload model artifacts
        uses: actions/upload-artifact@v4
        with:
          name: model-artifacts-${{ github.sha }}
          path: artifacts/
          retention-days: 30
  
  api-test:
    name: API Integration Tests
    runs-on: ubuntu-latest
    needs: [train]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download model artifacts
        uses: actions/download-artifact@v4
        with:
          name: model-artifacts-${{ github.sha }}
          path: artifacts/

      - name: Start API server
        env:
          API_KEY: ci-test-key
        run: |
          uvicorn src.server.app:app --host 0.0.0.0 --port 8000 &
          sleep 10

      - name: Test API endpoints
        run: |
          curl -f http://localhost:8000/health || exit 1
          curl -f -X POST http://localhost:8000/v1/predict \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ci-test-key" \
            -d '{"Amount":100.0,"transaction_hour":10,"region":"US","device_type":"mobile","merchant_category":"electronics","tx_last_24h":1,"tx_last_7d":3,"amount_to_avg_ratio":1.2,"is_weekend":0,"avg_amount_user":80.0}' || exit 1
  
  report:
    name: Pipeline Report
    runs-on: ubuntu-latest
    needs: [lint, test, train, api-test]
    if: always()
    steps:
      - name: Pipeline Status
        run: |
          echo "Lint: ${{ needs.lint.result }}"
          echo "Tests: ${{ needs.test.result }}"
          echo "Training: ${{ needs.train.result }}"
          echo "API Tests: ${{ needs.api-test.result }}"
          if [[ "${{ needs.lint.result }}" == "success" && \
                "${{ needs.test.result }}" == "success" && \
                "${{ needs.train.result }}" == "success" && \
                "${{ needs.api-test.result }}" == "success" ]]; then
            echo "CI passed"
          else
            echo "CI failed"
            exit 1
          fi
